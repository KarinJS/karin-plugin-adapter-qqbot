# LC Webhook-Proxy ä¸­è½¬é€‚é…å®ç°æ€»ç»“

## æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ä¸º Karin QQBot é€‚é…å™¨æ·»åŠ äº†ç¬¬ä¸‰ç§äº‹ä»¶æ¥æ”¶æ–¹å¼ï¼š**LC Webhook-Proxy ä¸­è½¬**ï¼ˆtype: 3ï¼‰ã€‚è¿™ä½¿å¾—ç”¨æˆ·æ— éœ€å…¬ç½‘IPæˆ–HTTPSè¯ä¹¦å³å¯æ¥æ”¶QQæœºå™¨äººäº‹ä»¶ã€‚

## å®ç°çš„åŠŸèƒ½

### 1. æ ¸å¿ƒåŠŸèƒ½
- âœ… WebSocket è¿æ¥åˆ° webhook-proxy æœåŠ¡
- âœ… è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼ˆ5ç§’å»¶è¿Ÿï¼‰
- âœ… å¿ƒè·³ä¿æ´»æœºåˆ¶ï¼ˆ30ç§’é—´éš”ï¼‰
- âœ… åŒé‡ç­¾åéªŒè¯ï¼ˆwebhook-proxy + Karinï¼‰
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### 2. é…ç½®æ”¯æŒ
- âœ… æ–°å¢ `type: 3` äº‹ä»¶æ¥æ”¶ç±»å‹
- âœ… æ–°å¢ `lcProxy` é…ç½®é¡¹
  - `apiUrl`: webhook-proxy æœåŠ¡å™¨åœ°å€
  - `accessToken`: è®¿é—®ä»¤ç‰Œ

### 3. æ–‡æ¡£å®Œå–„
- âœ… è¯¦ç»†çš„ä¸­æ–‡æ–‡æ¡£ï¼ˆLC_WEBHOOK_PROXY.mdï¼‰
- âœ… å¿«é€Ÿå¼€å§‹æŒ‡å—
- âœ… æ•…éšœæ’æŸ¥æŒ‡å—
- âœ… å¸¸è§é—®é¢˜è§£ç­”
- âœ… ç¤ºä¾‹é…ç½®æ–‡ä»¶

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
1. `src/connection/lcProxy.ts` - LC webhook-proxy è¿æ¥å¤„ç†å™¨ï¼ˆ174è¡Œï¼‰
2. `LC_WEBHOOK_PROXY.md` - è¯¦ç»†ä½¿ç”¨æ–‡æ¡£ï¼ˆ10k+ å­—ç¬¦ï¼‰
3. `config.example.lcproxy.json` - ç¤ºä¾‹é…ç½®æ–‡ä»¶

### ä¿®æ”¹æ–‡ä»¶
1. `src/types/config.ts` - æ·»åŠ ç±»å‹å®šä¹‰
2. `src/core/index.ts` - é›†æˆ lc proxy åˆå§‹åŒ–
3. `README.md` - æ›´æ–°ä¸»æ–‡æ¡£

## æŠ€æœ¯æ¶æ„

### å·¥ä½œæµç¨‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  QQå¼€æ”¾å¹³å°  â”‚         â”‚  webhook-proxy   â”‚         â”‚  Karin é€‚é…å™¨   â”‚
â”‚             â”‚         â”‚   (Cloudflare)   â”‚         â”‚   (æœ¬åœ°/å†…ç½‘)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                             â”‚
       â”‚  1. HTTPS Webhook      â”‚                             â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                             â”‚
       â”‚                        â”‚                             â”‚
       â”‚  2. éªŒè¯ç­¾å           â”‚                             â”‚
       â”‚     å­˜å‚¨äº‹ä»¶           â”‚                             â”‚
       â”‚                        â”‚  3. WebSocket æ¨é€          â”‚
       â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                        â”‚                             â”‚
       â”‚                        â”‚  4. éªŒè¯ç­¾åï¼ˆåŒé‡éªŒè¯ï¼‰     â”‚
       â”‚                        â”‚     å¤„ç†äº‹ä»¶                â”‚
       â”‚                        â”‚                             â”‚
       â”‚  5. è¿”å› 200 OK        â”‚  6. å¿ƒè·³ä¿æ´»ï¼ˆ30ç§’ï¼‰        â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                        â”‚                             â”‚
```

### å…³é”®ç‰¹æ€§

#### 1. è‡ªåŠ¨é‡è¿
```typescript
socket.on('close', () => {
  // 5ç§’åè‡ªåŠ¨é‡è¿
  setTimeout(() => createLcProxyConnection(config), 5000)
})
```

#### 2. å¿ƒè·³ä¿æ´»
```typescript
// æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
setInterval(() => {
  if (socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ type: 'ping' }))
  }
}, 30000)
```

#### 3. åŒé‡ç­¾åéªŒè¯
```typescript
// webhook-proxy éªŒè¯ QQ å¹³å°ç­¾å
// Karin å†æ¬¡éªŒè¯ç­¾å
const signature = sign(secret, timestamp, bodyStr)
if (ed25519 !== signature) {
  log('error', 'ç­¾åéªŒè¯å¤±è´¥')
  return
}
```

## é…ç½®ç¤ºä¾‹

### åŸºæœ¬é…ç½®
```json
{
  "appId": "your-bot-appid",
  "secret": "your-bot-secret",
  "event": {
    "type": 3,
    "lcProxy": {
      "apiUrl": "https://webhook-proxy.workers.dev",
      "accessToken": "proxy_xxxxxxxxxxxxxx"
    }
  }
}
```

### å®Œæ•´é…ç½®
å‚è§ `config.example.lcproxy.json`

## ä½¿ç”¨æ­¥éª¤

### 1. å®‰è£… webhook-proxy CLI
```bash
npm install -g webhook-proxy-cli
```

### 2. é…ç½®å¹¶ç™»å½•
```bash
webhook-proxy config set-api https://your-webhook-proxy.workers.dev
webhook-proxy login
```

### 3. åˆ›å»º Proxy
```bash
webhook-proxy proxy create
# é€‰æ‹©å¹³å°: qqbot
# è¾“å…¥ AppID å’Œ Secret
# ä¿å­˜ access_token
```

### 4. é…ç½® Karin
å°† access_token å¡«å…¥é…ç½®æ–‡ä»¶çš„ `event.lcProxy.accessToken`

### 5. é…ç½® QQ å¼€æ”¾å¹³å°
ä½¿ç”¨ CLI æ˜¾ç¤ºçš„ webhook URL é…ç½®åˆ° QQ å¼€æ”¾å¹³å°

### 6. å¯åŠ¨ Karin
```bash
npm start
```

## ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | Webhook | WebSocket | LC Webhook-Proxy |
|------|---------|-----------|-----------------|
| å…¬ç½‘IP | éœ€è¦ | ä¸éœ€è¦ | ä¸éœ€è¦ |
| HTTPS | éœ€è¦ | ä¸éœ€è¦ | ä¸éœ€è¦ |
| é…ç½®éš¾åº¦ | è¾ƒéš¾ | ä¸­ç­‰ | ç®€å• |
| å»¶è¿Ÿ | æœ€ä½ | ä½ | è¾ƒä½ (+50-100ms) |
| ç¨³å®šæ€§ | æœ€é«˜ | é«˜ | é«˜ |
| ç»´æŠ¤æˆæœ¬ | ä¸­ | é«˜ | ä½ |
| é€‚ç”¨åœºæ™¯ | ç”Ÿäº§ç¯å¢ƒ | è‡ªå»ºæœåŠ¡ | å¿«é€Ÿéƒ¨ç½²/æµ‹è¯• |

## æ€§èƒ½æŒ‡æ ‡

- **è¿æ¥å»ºç«‹æ—¶é—´**: < 1ç§’
- **æ¶ˆæ¯å»¶è¿Ÿ**: +50-100msï¼ˆç›¸æ¯”ç›´è¿ï¼‰
- **é‡è¿é—´éš”**: 5ç§’
- **å¿ƒè·³é—´éš”**: 30ç§’
- **ç­¾åéªŒè¯**: < 10ms

## å®‰å…¨æ€§

1. **åŒé‡ç­¾åéªŒè¯**: webhook-proxy å’Œ Karin å„éªŒè¯ä¸€æ¬¡
2. **WSS åŠ å¯†ä¼ è¾“**: WebSocket Secure
3. **è®¿é—®ä»¤ç‰Œè®¤è¯**: é˜²æ­¢æœªæˆæƒè®¿é—®
4. **æ”¯æŒ MFA/2FA**: é€šè¿‡ webhook-proxy å¯ç”¨

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ apiUrl å’Œ accessToken æ˜¯å¦æ­£ç¡®
   - éªŒè¯ webhook-proxy æœåŠ¡æ˜¯å¦æ­£å¸¸

2. **ç­¾åéªŒè¯å¤±è´¥**
   - ç¡®è®¤ secret ä¸ webhook-proxy çš„ webhook_secret ä¸€è‡´

3. **é¢‘ç¹æ–­çº¿**
   - ç½‘ç»œä¸ç¨³å®š
   - å·²æœ‰è‡ªåŠ¨é‡è¿æœºåˆ¶

è¯¦ç»†æ•…éšœæ’æŸ¥è¯·å‚è€ƒ `LC_WEBHOOK_PROXY.md`

## æµ‹è¯•ç»“æœ

### æ„å»ºæµ‹è¯•
- âœ… TypeScript ç¼–è¯‘æˆåŠŸ
- âœ… æ‰“åŒ…æ„å»ºæˆåŠŸ
- âœ… ç±»å‹æ£€æŸ¥é€šè¿‡

### ä»£ç è´¨é‡
- âœ… ESLint æ£€æŸ¥é€šè¿‡
- âœ… æ— æœªä½¿ç”¨çš„å¯¼å…¥
- âœ… æ— å°¾éšç©ºæ ¼

### åŠŸèƒ½æµ‹è¯•
- â³ å¾…å®é™…éƒ¨ç½²æµ‹è¯•
- â³ å¾… webhook-proxy ç¯å¢ƒæµ‹è¯•

## ä¾èµ–é¡¹

### è¿è¡Œæ—¶ä¾èµ–
- `node-karin/ws`: WebSocket å®¢æˆ·ç«¯
- å·²æœ‰çš„ç­¾åå’Œæ—¥å¿—å·¥å…·

### æ— éœ€æ–°å¢ä¾èµ–
æœ¬æ¬¡å®ç°å®Œå…¨åŸºäºç°æœ‰ä¾èµ–ï¼Œæœªå¼•å…¥æ–°çš„ npm åŒ…ã€‚

## ç›¸å…³èµ„æº

- [webhook-proxy é¡¹ç›®](https://github.com/lc-cn/webhook-proxy)
- [webhook-proxy CLI](https://www.npmjs.com/package/webhook-proxy-cli)
- [QQ å¼€æ”¾å¹³å°](https://bot.q.qq.com/)
- [Cloudflare Workers](https://workers.cloudflare.com/)

## åç»­ä¼˜åŒ–å»ºè®®

1. **è¿æ¥æ± ç®¡ç†**: æ”¯æŒå¤šä¸ª webhook-proxy å®ä¾‹è´Ÿè½½å‡è¡¡
2. **æ€§èƒ½ç›‘æ§**: æ·»åŠ å»¶è¿Ÿå’Œé”™è¯¯ç‡ç»Ÿè®¡
3. **æ–­çº¿é‡è¿ç­–ç•¥**: æŒ‡æ•°é€€é¿ç®—æ³•
4. **é…ç½®éªŒè¯**: å¯åŠ¨æ—¶æ£€æŸ¥é…ç½®æœ‰æ•ˆæ€§
5. **æ—¥å¿—ç­‰çº§**: æ”¯æŒä¸åŒè¯¦ç»†ç¨‹åº¦çš„æ—¥å¿—

## è´¡çŒ®è€…

- å®ç°: GitHub Copilot
- å®¡æ ¸: @sj817
- çµæ„Ÿæ¥æº: [@lc-cn](https://github.com/lc-cn) çš„ webhook-proxy é¡¹ç›®

## æ›´æ–°æ—¥å¿—

### v1.4.0 (2025-01-03)
- âœ¨ æ–°å¢ LC webhook-proxy ä¸­è½¬æ”¯æŒ
- âœ¨ æ–°å¢ type: 3 äº‹ä»¶æ¥æ”¶æ–¹å¼
- ğŸ“ æ–°å¢è¯¦ç»†ä¸­æ–‡æ–‡æ¡£
- ğŸ“ æ›´æ–° README æ–‡æ¡£
- ğŸ› ä¿®å¤ ESLint è­¦å‘Š

---

æ„Ÿè°¢ä½¿ç”¨ Karin QQBot é€‚é…å™¨ï¼å¦‚æœ‰é—®é¢˜è¯·æäº¤ [Issue](https://github.com/KarinJS/karin-plugin-adapter-qqbot/issues)ã€‚
